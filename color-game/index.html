<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Big Ben Color Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; color: white; overflow-x: hidden; }
        .screen { display: none; }
        .screen.active { display: flex; }
        .casino-card { background: #1e293b; border-radius: 2.5rem; border: 1px solid #334155; }
        .zone-btn { aspect-ratio: 1/1; border-radius: 1.5rem; transition: all 0.2s; border: 4px solid transparent; }
        .zone-btn.selected { border-color: white; transform: scale(0.95); box-shadow: 0 0 20px rgba(255,255,255,0.4); }
        .eliminated { text-decoration: line-through; opacity: 0.4; filter: grayscale(1); }
        .dice-box { width: 3.5rem; height: 3.5rem; border-radius: 0.8rem; display: flex; align-items: center; justify-content: center; font-weight: 900; color: black; transition: all 0.1s; border: 1px solid rgba(255,255,255,0.1); }
        
        @keyframes casino-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-2px, -1px) rotate(-1deg); }
            50% { transform: translate(-1px, 2px) rotate(0deg); }
            75% { transform: translate(2px, 1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(0deg); }
        }
        .is-rolling { animation: casino-shake 0.1s infinite linear; filter: brightness(1.3) contrast(1.2); }
        .rolling-row { animation: casino-shake 0.2s infinite alternate; }
        #qrcode img { margin: 0 auto; border-radius: 0.5rem; padding: 5px; background: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <div id="screenInitial" class="screen active fixed inset-0 flex-col items-center justify-center p-4">
        <div class="casino-card p-8 w-full max-w-md text-center shadow-2xl">
            <h1 class="text-4xl font-black italic mb-8 uppercase tracking-tighter italic">Big Ben<br/><span class="text-red-500">Color Game</span></h1>
            <div class="flex flex-col gap-3">
                <button onclick="showScreen('screenCreate')" class="bg-white text-black font-black py-4 rounded-2xl tracking-widest hover:bg-slate-200 transition uppercase">Create Room</button>
                <button onclick="showScreen('screenJoin')" class="bg-red-600 text-white font-black py-4 rounded-2xl tracking-widest hover:bg-red-700 transition uppercase">Join Room</button>
            </div>
        </div>
    </div>

    <div id="screenCreate" class="screen fixed inset-0 flex-col items-center justify-center p-4">
        <div class="casino-card p-8 w-full max-w-md">
            <h2 class="text-xl font-black mb-6 uppercase tracking-widest">Host Game</h2>
            <input id="hostName" type="text" placeholder="Your Name" class="w-full bg-slate-800 border-none rounded-2xl px-5 py-4 mb-4 font-bold text-white outline-none ring-2 ring-transparent focus:ring-white">
            <button onclick="handleCreateRoom()" class="w-full bg-white text-black font-black py-4 rounded-2xl uppercase">Generate Code</button>
            <button onclick="showScreen('screenInitial')" class="w-full text-slate-500 mt-4 text-[10px] font-black uppercase tracking-widest">Cancel</button>
        </div>
    </div>

    <div id="screenJoin" class="screen fixed inset-0 flex-col items-center justify-center p-4">
        <div class="casino-card p-8 w-full max-w-md">
            <h2 class="text-xl font-black mb-6 uppercase tracking-widest text-white">Join Game</h2>
            <input id="playerName" type="text" placeholder="Your Name" class="w-full bg-slate-800 rounded-2xl px-5 py-4 mb-3 font-bold text-white outline-none ring-2 ring-transparent focus:ring-red-500">
            <input id="joinCode" type="text" placeholder="Room Code" class="w-full bg-slate-800 rounded-2xl px-5 py-4 mb-4 font-bold text-white text-center uppercase tracking-widest outline-none ring-2 ring-transparent focus:ring-red-500">
            <button onclick="handleJoinRoom()" class="w-full bg-red-600 text-white font-black py-4 rounded-2xl uppercase">Enter Room</button>
            <button onclick="showScreen('screenInitial')" class="w-full text-slate-500 mt-4 text-[10px] font-black uppercase tracking-widest">Cancel</button>
        </div>
    </div>

    <div id="screenWaiting" class="screen fixed inset-0 flex-col items-center justify-center p-4">
        <div class="casino-card p-8 w-full max-w-md text-center">
            <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-4">Scan to Join</p>
            <div id="qrcode" class="mb-6"></div>
            <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-1">Room Code</p>
            <div id="displayCode" class="text-6xl font-black mb-4 text-white tracking-tighter">-----</div>
            <button onclick="copyInviteLink()" class="bg-slate-700/50 hover:bg-slate-700 text-[10px] font-black py-2 px-6 rounded-full mb-8 uppercase tracking-widest transition">Share Link</button>
            <div class="text-left mb-8">
                <p class="text-[10px] font-black text-slate-500 uppercase mb-3 tracking-widest italic">Players</p>
                <div id="playerList" class="space-y-2"></div>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="enterGamePanel()" class="w-full bg-white text-black font-black py-4 rounded-2xl uppercase shadow-xl transition">Enter Game Panel</button>
                <div id="lobbyHostActions" class="hidden">
                    <button onclick="closeRoom()" class="w-full bg-red-600 text-white font-black py-3 rounded-2xl uppercase text-xs tracking-widest transition active:scale-95">Close Room</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screenGame" class="screen flex-col min-h-screen w-full">
        <header class="p-4 flex justify-between items-center bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
            <h1 class="font-black italic text-sm tracking-tighter uppercase">Big Ben <span class="text-red-500">Color Game</span></h1>
            <div id="headerActions"></div>
        </header>

        <main class="p-4 grid lg:grid-cols-12 gap-6 max-w-7xl mx-auto w-full">
            <div class="lg:col-span-8 grid grid-cols-2 sm:grid-cols-3 gap-3" id="zonesGrid"></div>
            <div class="lg:col-span-4 space-y-4">
                <div class="bg-slate-800 p-4 rounded-[2rem] border border-slate-700 shadow-xl">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest text-center mb-3 italic text-xs uppercase">Live Result</p>
                    <div class="flex justify-center gap-2">
                        <div id="pub-d1" class="dice-box bg-white">?</div>
                        <div id="pub-d2" class="dice-box bg-white">?</div>
                        <div id="pub-d3" class="dice-box bg-white">?</div>
                    </div>
                </div>
                <div id="hostControls" class="hidden bg-slate-900 p-6 rounded-[2.5rem] border border-red-900/30 shadow-2xl text-center">
                    <button id="rollBtn" onclick="handleHostRoll()" class="w-full bg-red-600 hover:bg-red-700 py-4 rounded-2xl font-black uppercase tracking-widest text-xs transition">Draw Colors</button>
                    <button onclick="handleResetGame()" class="w-full mt-3 text-slate-600 hover:text-white text-[9px] font-black uppercase tracking-widest transition">Reset Game</button>
                </div>
                <div class="bg-slate-800 rounded-[2.5rem] border border-slate-700 overflow-hidden shadow-xl">
                    <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                        <h3 class="text-[10px] font-black uppercase text-slate-400 tracking-widest italic">Leaderboard</h3>
                        <span id="roomTag" onclick="copyInviteLink()" 
                              class="text-[10px] font-black text-red-500 bg-red-500/10 px-2 py-1 rounded tracking-widest uppercase cursor-pointer hover:bg-red-500/20 transition active:scale-95"></span>
                    </div>
                    <div id="leaderboardList" class="divide-y divide-slate-700"></div>
                </div>
            </div>
        </main>
    </div>

    <footer id="mainFooter" class="mt-auto mb-8 flex flex-col items-center gap-4 opacity-60">
        <div class="h-px w-24 bg-slate-300"></div>
        <div class="flex items-center gap-2">
            <img src="https://scrmbldgreg.github.io/bingo-manila/assets/gemini-ai-logo.png" alt="Gemini Logo" class="w-4 h-4 md:w-6 md:h-6 animate-pulse">
            <p class="text-[8px] md:text-[10px] font-bold tracking-[0.2em] text-white uppercase">Powered by Gemini AI</p>
        </div>
        <p class="text-[8px] font-medium text-slate-400 tracking-wider uppercase">&copy; 2026 Big Ben Manila</p>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBznF9jfkpSnKigpMnM706dXL_ZMOjUOAw",
            authDomain: "bingo-manila.firebaseapp.com",
            databaseURL: "https://bingo-manila-default-rtdb.firebaseio.com",
            projectId: "bingo-manila",
            storageBucket: "bingo-manila.firebasestorage.app",
            messagingSenderId: "792321653174",
            appId: "1:792321653174:web:1cf7c925f055b7134f6917",
            measurementId: "G-4Q004H7XWG"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId = "p-" + Date.now();
        let myName = "", currentRoom = null, isHost = false, globalIsRolling = false;
        let lastRollingState = false, animationInterval = null;

        const COLORS = [
            { name: 'Red', hex: '#ef4444' }, { name: 'Green', hex: '#22c55e' },
            { name: 'Blue', hex: '#3b82f6' }, { name: 'Yellow', hex: '#eab308' },
            { name: 'Pink', hex: '#ec4899' }, { name: 'White', hex: '#ffffff' }
        ];

        /* --- SESSION & FOOTER LOGIC --- */
        window.onload = async () => {
            const savedSession = localStorage.getItem('cg_session');
            const params = new URLSearchParams(window.location.search);
            const joinCode = params.get('join');

            if (savedSession) {
                const session = JSON.parse(savedSession);
                const snap = await db.ref('rooms/' + session.room).get();
                if (snap.exists()) {
                    myId = session.id;
                    myName = session.name;
                    currentRoom = session.room;
                    isHost = session.isHost;
                    startLobbySync();
                    generateQR(currentRoom);
                    if (isHost) document.getElementById('lobbyHostActions').classList.remove('hidden');
                    enterGamePanel();
                    return;
                } else {
                    localStorage.removeItem('cg_session');
                }
            }

            if (joinCode) {
                showScreen('screenJoin');
                document.getElementById('joinCode').value = joinCode;
            }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Hide footer in Game Panel
            const footer = document.getElementById('mainFooter');
            if (id === 'screenGame') {
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
            }
        }

        function saveSession() {
            localStorage.setItem('cg_session', JSON.stringify({
                id: myId, name: myName, room: currentRoom, isHost: isHost
            }));
        }

        function clearSession() {
            localStorage.removeItem('cg_session');
        }

        function generateQR(roomCode) {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            const inviteUrl = `${window.location.origin}${window.location.pathname}?join=${roomCode}`;
            new QRCode(qrContainer, {
                text: inviteUrl, width: 160, height: 160,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        async function handleCreateRoom() {
            myName = document.getElementById('hostName').value.trim();
            if (!myName) return alert("Enter name");
            currentRoom = Math.random().toString(36).substring(2, 7).toUpperCase();
            isHost = true;
            await db.ref('rooms/' + currentRoom).set({ hostId: myId, result: ['?','?','?'], isRolling: false });
            await db.ref(`rooms/${currentRoom}/players/${myId}`).set({ name: myName, coins: 10, zone: 'none', isHost: true });
            saveSession();
            startLobbySync();
            generateQR(currentRoom);
            document.getElementById('lobbyHostActions').classList.remove('hidden');
        }

        async function handleJoinRoom() {
            myName = document.getElementById('playerName').value.trim();
            currentRoom = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!myName || !currentRoom) return alert("Missing info");
            const snap = await db.ref('rooms/' + currentRoom).get();
            if (!snap.exists()) return alert("Room not found");
            await db.ref(`rooms/${currentRoom}/players/${myId}`).set({ name: myName, coins: 10, zone: 'none', isHost: false });
            saveSession();
            startLobbySync();
            generateQR(currentRoom);
        }

        function startLobbySync() {
            document.getElementById('displayCode').textContent = currentRoom;
            showScreen('screenWaiting');
            db.ref(`rooms/${currentRoom}/players`).on('value', (snap) => {
                const players = snap.val() || {};
                if (!players[myId]) { 
                    alert("You have been kicked or the room closed."); 
                    clearSession();
                    location.reload(); 
                    return; 
                }
                document.getElementById('playerList').innerHTML = Object.entries(players).map(([id, p]) => `
                    <div class="flex justify-between items-center bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                        <span class="text-sm font-bold tracking-tight">${p.name}</span>
                        <div class="flex items-center gap-2">
                            ${p.isHost ? '<span class="text-[8px] font-black uppercase text-red-500 bg-red-500/10 px-2 py-0.5 rounded border border-red-500/20">Host</span>' : ''}
                            ${isHost && !p.isHost ? `<button onclick="kickPlayer('${id}')" class="text-[8px] bg-red-600 px-3 py-1 rounded-lg font-black uppercase">Kick</button>` : ''}
                        </div>
                    </div>
                `).join('');
            });
            db.ref(`rooms/${currentRoom}`).on('value', (snap) => {
                if (!snap.exists()) { clearSession(); location.reload(); }
            });
        }

        function enterGamePanel() {
            showScreen('screenGame');
            document.getElementById('roomTag').textContent = currentRoom;
            const headerActions = document.getElementById('headerActions');
            if (isHost) {
                headerActions.innerHTML = `<button onclick="closeRoom()" class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase shadow-lg transition active:scale-95">Close Room</button>`;
                document.getElementById('hostControls').classList.remove('hidden');
            } else {
                headerActions.innerHTML = `<button onclick="leaveRoom()" class="bg-slate-800 text-slate-400 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest transition">Leave</button>`;
            }
            initGame();
        }

        function initGame() {
            const grid = document.getElementById('zonesGrid');
            grid.innerHTML = COLORS.map(c => `<button onclick="setBet('${c.name}')" id="btn-${c.name}" class="zone-btn" style="background-color: ${c.hex}"></button>`).join('');

            db.ref(`rooms/${currentRoom}`).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;
                globalIsRolling = data.isRolling;
                const players = data.players || {};
                
                if (lastRollingState === true && globalIsRolling === false) {
                    const me = players[myId];
                    if (me && data.result.includes(me.zone)) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
                lastRollingState = globalIsRolling;

                const leaderboard = document.getElementById('leaderboardList');
                leaderboard.innerHTML = Object.entries(players).sort((a,b) => b[1].coins - a[1].coins).map(([id, p]) => {
                    const col = COLORS.find(c => c.name === p.zone);
                    const rowClass = globalIsRolling && p.zone !== 'none' ? 'rolling-row is-rolling' : '';
                    return `
                        <div id="row-${id}" class="p-4 flex justify-between items-center transition-all ${rowClass}" style="background-color: ${col ? col.hex + '22' : 'transparent'}">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold ${p.coins <= 0 ? 'eliminated' : ''}">${p.name}</span>
                                <div class="flex gap-2 mt-1">
                                    ${isHost && id !== myId ? `<button onclick="kickPlayer('${id}')" class="text-[7px] text-red-500 font-bold uppercase">Kick</button>` : ''}
                                    ${isHost ? `<button onclick="addCoin('${id}')" class="text-[7px] text-green-500 font-bold uppercase tracking-widest">+1 üèÜ</button>` : ''}
                                </div>
                            </div>
                            <span class="text-xs font-black">${p.coins} üèÜ</span>
                        </div>
                    `;
                }).join('');

                if (globalIsRolling) startDiceOnlyAnimation(); else updateDiceDisplay(data.result);
                const me = players[myId];
                if (!me) return;
                document.querySelectorAll('.zone-btn').forEach(b => b.classList.remove('selected'));
                if (me.zone !== 'none') {
                    const myBtn = document.getElementById(`btn-${me.zone}`);
                    if (myBtn) myBtn.classList.add('selected');
                }
            });
        }

        function startDiceOnlyAnimation() {
            if (animationInterval) return;
            const dice = [document.getElementById('pub-d1'), document.getElementById('pub-d2'), document.getElementById('pub-d3')];
            animationInterval = setInterval(() => {
                dice.forEach(d => {
                    const rand = COLORS[Math.floor(Math.random() * 6)];
                    d.style.backgroundColor = rand.hex; d.textContent = ""; d.classList.add('is-rolling');
                });
            }, 80);
        }

        function updateDiceDisplay(res) {
            if (animationInterval) { clearInterval(animationInterval); animationInterval = null; }
            [1, 2, 3].forEach(i => {
                const d = document.getElementById(`pub-d${i}`);
                if (d) {
                    d.classList.remove('is-rolling');
                    const colorName = res[i-1];
                    const col = COLORS.find(c => c.name === colorName);
                    if (col) { d.style.backgroundColor = col.hex; d.textContent = ""; d.style.opacity = "1"; }
                    else { d.style.backgroundColor = "#fff"; d.textContent = "?"; d.style.opacity = "0.5"; }
                }
            });
        }

        function setBet(color) { if(globalIsRolling) return; db.ref(`rooms/${currentRoom}/players/${myId}/zone`).set(color); }
        function kickPlayer(id) { if(confirm("Kick player?")) db.ref(`rooms/${currentRoom}/players/${id}`).remove(); }
        function addCoin(id) { db.ref(`rooms/${currentRoom}/players/${id}/coins`).transaction(c => (c || 0) + 1); }
        
        function leaveRoom() { 
            if(confirm("Leave room?")) { 
                db.ref(`rooms/${currentRoom}/players/${myId}`).remove(); 
                clearSession();
                location.reload(); 
            } 
        }
        
        function closeRoom() { 
            if(confirm("End game and delete room?")) {
                db.ref(`rooms/${currentRoom}`).remove(); 
                clearSession();
            }
        }
        
        async function handleResetGame() {
            const snap = await db.ref(`rooms/${currentRoom}/players`).get();
            const updates = {};
            if (snap.exists()) {
                Object.keys(snap.val()).forEach(id => { updates[`players/${id}/coins`] = 10; updates[`players/${id}/zone`] = 'none'; });
            }
            updates['result'] = ['?','?','?']; updates['isRolling'] = false;
            db.ref(`rooms/${currentRoom}`).update(updates);
        }

        async function handleHostRoll() {
            if(globalIsRolling) return;
            const btn = document.getElementById('rollBtn'); btn.disabled = true;
            await db.ref(`rooms/${currentRoom}/isRolling`).set(true);
            setTimeout(async () => {
                const res = [COLORS[Math.floor(Math.random()*6)].name, COLORS[Math.floor(Math.random()*6)].name, COLORS[Math.floor(Math.random()*6)].name];
                const snap = await db.ref(`rooms/${currentRoom}/players`).get();
                const players = snap.val();
                const updates = { isRolling: false, result: res };
                Object.entries(players).forEach(([id, p]) => {
                    if (p.zone !== 'none') {
                        const matches = res.filter(c => c === p.zone).length;
                        updates[`players/${id}/coins`] = Math.max(0, p.coins + (matches > 0 ? matches : -1));
                        updates[`players/${id}/zone`] = 'none'; 
                    }
                });
                await db.ref(`rooms/${currentRoom}`).update(updates);
                btn.disabled = false;
            }, 2000);
        }

        function copyInviteLink() {
            const link = `${window.location.origin}${window.location.pathname}?join=${currentRoom}`;
            navigator.clipboard.writeText(link).then(() => alert("Link Copied!"));
        }
    </script>
</body>
</html>
