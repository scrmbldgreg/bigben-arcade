<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Big Ben Bingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
      /* --- ORIGINAL BIG BEN MANILA BRANDING --- */
      :root { --london-blue: #002147; --royal-red: #991b1b; }
      .bg-london-blue { background-color: var(--london-blue); }
      .text-london-blue { color: var(--london-blue); }
      .bg-royal-red { background-color: var(--royal-red); }
      button { touch-action: manipulation; }
      
      .marked { position: relative; background-color: #10b981 !important; color: white !important; }
      .marked::after { content: '‚úñ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.4); font-size: 1.2rem; }
      .winning-cell { position: relative; background-color: #fef08a !important; color: #854d0e !important; }
      .winning-cell::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background-color: var(--royal-red); transform: translateY(-50%); z-index: 10; pointer-events: none; }
      
      .no-scrollbar::-webkit-scrollbar { width: 0px; }
      #gamePlayerList::-webkit-scrollbar { width: 4px; }
      #gamePlayerList::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      
      @keyframes slot-spin { 0% { transform: translateY(-20px); opacity: 0; } 50% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(20px); opacity: 0; } }
      .slot-rolling { animation: slot-spin 0.1s linear infinite; color: var(--royal-red) !important; }

      /* FIX: Proper Scroll Removal & Centering */
html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Strictly removes scroll */
    }

    body {
        display: flex;
        flex-direction: column;
        /* Centers everything perfectly on the screen */
        justify-content: center; 
        align-items: center; 
        background-color: #f8fafc;
        position: relative;
    }

    /* Keep the Game Area scrollable internally so it doesn't break */
    #gameArea {
        position: fixed;
        inset: 0;
        background: #f8fafc;
        z-index: 100;
        overflow-y: auto; 
        display: none;
        flex-direction: column;
    }

    #winnerModal {
    z-index: 9999 !important;
    pointer-events: auto !important;
}
  </style>

<body class="font-sans text-slate-900">
    <div id="initialScreensWrapper" class="flex flex-col items-center justify-center w-full">
        </div>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 font-sans text-slate-900 overflow-x-hidden">

  <!-- <div class="flex-1 w-full flex flex-col items-center"> -->
    <!-- <div class="w-20 h-20 md:w-32 md:h-32 rounded-full border-4 border-white shadow-lg flex items-center justify-center overflow-hidden mb-2">
      <img src="https://scrmbldgreg.github.io/bingo-manila/assets/bigbenmnl.png" alt="Big Ben Manila Logo" class="w-full h-full object-contain p-2">
    </div> -->
    <!-- <h1 class="text-xl md:text-2xl font-black tracking-tighter text-london-blue uppercase">Big Ben Bingo</h1> -->
  <!-- </div> -->

<div id="screenInitial" class="bg-white p-8 md:p-10 rounded-3xl shadow-xl w-full max-w-md flex flex-col gap-5 text-center border-2 border-slate-100">
    <div class="mb-4">
        <h1 class="text-3xl font-black tracking-tighter text-london-blue uppercase">Big Ben Bingo</h1>
        <!-- <p class="text-slate-400 text-xs font-bold tracking-widest mt-1">SELECT AN OPTION</p> -->
    </div>
    
    <button onclick="showScreen('screenCreate')" class="bg-london-blue hover:opacity-90 text-white font-bold py-5 rounded-2xl transition shadow-lg active:scale-95 text-lg">
        CREATE ROOM
    </button>
<!--     
    <div class="flex items-center gap-3 my-1">
        <div class="h-px bg-slate-200 flex-1"></div>
        <span class="text-slate-300 font-bold text-xs">OR</span>
        <div class="h-px bg-slate-200 flex-1"></div>
    </div> -->

    <button onclick="showScreen('screenJoin')" class="bg-royal-red hover:opacity-90 text-white font-bold py-5 rounded-2xl transition shadow-lg shadow-red-100 active:scale-95 text-lg">
        JOIN ROOM
    </button>
</div>

  <div id="screenCreate" class="hidden bg-white p-6 md:p-8 rounded-3xl shadow-xl w-full max-w-md border-t-8 border-london-blue">
    <h2 class="text-xl font-bold mb-4 text-london-blue">Host a Game</h2>
    <input id="hostName" type="text" placeholder="Your Name" class="border-2 rounded-xl p-3 w-full mb-4 outline-none focus:border-london-blue appearance-none">
    <button onclick="handleCreateLobby()" class="bg-london-blue text-white font-bold py-3 rounded-xl w-full uppercase active:scale-95 transition">Generate Room Code</button>
    <button onclick="showScreen('screenInitial')" class="text-slate-400 mt-4 w-full text-sm hover:underline text-center py-2">‚Üê Cancel</button>
  </div>

  <div id="screenJoin" class="hidden bg-white p-6 md:p-8 rounded-3xl shadow-xl w-full max-w-md border-t-8 border-royal-red">
    <h2 class="text-xl font-bold mb-4 text-royal-red">Join Room</h2>
    <input id="playerName" type="text" placeholder="Your Name" class="border-2 rounded-xl p-3 w-full mb-3 outline-none focus:border-royal-red appearance-none">
    <input id="joinCode" type="text" placeholder="Room Code" class="border-2 rounded-xl p-3 w-full mb-4 outline-none uppercase tracking-widest text-center font-bold appearance-none">
    <button onclick="handleJoinLobby()" class="bg-royal-red text-white font-bold py-3 rounded-xl w-full uppercase active:scale-95 transition">Enter Room</button>
    <button onclick="showScreen('screenInitial')" class="text-slate-400 mt-4 w-full text-sm hover:underline text-center py-2">‚Üê Cancel</button>
  </div>

  <div id="screenLobbyRoom" class="hidden bg-white p-6 md:p-8 rounded-3xl shadow-xl w-full max-w-lg border-x-8 border-london-blue">
    <div class="text-center mb-6">
      <span class="text-slate-400 uppercase text-xs font-bold tracking-widest">Room Code</span>
      <div id="displayCode" class="text-5xl md:text-6xl font-black text-london-blue mt-1">XXXXX</div>
    </div>
    <div class="flex justify-center mb-6">
        <div id="qrcode" class="p-2 bg-white border-2 border-slate-100 rounded-xl shadow-sm"></div>
    </div>
    <div class="flex flex-col items-center gap-2 mt-4 mb-4">
      <button onclick="copyInviteLink()" class="bg-slate-100 hover:bg-slate-200 text-london-blue text-[10px] font-bold py-3 px-6 rounded-full transition flex items-center gap-2 active:bg-slate-300">
        <span id="shareBtnText">COPY INVITE LINK</span>
      </button>
    </div>
    <div class="bg-slate-50 rounded-2xl p-4 mb-6">
      <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2 text-sm">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
        Waiting for Players...
      </h3>
      <ul id="playerList" class="space-y-2 max-h-40 overflow-y-auto"></ul>
    </div>
    <button onclick="enterGamePanel()" class="bg-london-blue text-white font-bold py-4 rounded-2xl w-full shadow-xl active:scale-95 transition">ENTER GAME PANEL</button>
    <button onclick="leaveRoom()" id="btnCancelLobby" class="hidden mt-4 text-slate-400 hover:text-royal-red text-[10px] font-bold uppercase tracking-widest w-full text-center transition py-2">
      Close Room
    </button>
  </div>

<div id="gameArea" class="hidden w-full flex flex-col pb-24 relative min-h-screen">
<header class="w-full bg-london-blue shadow-lg sticky top-0 z-50">
    <div class="w-full px-6 py-4 flex justify-between items-center">
        <div class="flex flex-col">
            <h1 class="font-black italic text-xl tracking-tighter uppercase text-white leading-none">
                Big Ben <span class="text-royal-red">Bingo</span>
            </h1>
            <span id="headerRoomDisplay" class="text-[10px] font-bold text-white/40 uppercase mt-1"></span>
        </div>
        <button id="btnCloseRoom" onclick="leaveRoom()" class="hidden bg-royal-red text-white px-3 py-1 rounded-lg font-black text-xs uppercase shadow-md active:scale-95 transition">
            Close Room
        </button>
    </div>
</header>

    <div class="flex-1 w-full max-w-7xl mx-auto p-4 md:p-8">
        <div class="grid lg:grid-cols-4 gap-6">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-lg border-t-8 border-london-blue text-center">
                    <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Now Calling</span>
                    <div id="bingoCurrent" class="text-6xl font-black text-london-blue my-2">-</div>
                    <div class="border-t border-slate-100 pt-4">
                        <span class="text-slate-400 text-[10px] font-bold uppercase block mb-3 text-center">History</span>
                        <div id="historyBox" class="min-h-[100px] flex flex-wrap justify-center gap-1.5"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div id="cardWrapper" class="p-4 md:p-8 rounded-[40px] shadow-2xl bg-london-blue border-4 border-white/10 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-white">
                            <h2 id="cardOwnerName" class="text-2xl font-black uppercase italic tracking-tighter">Your Card</h2>
                            <p class="text-[10px] font-bold text-white/50 uppercase">Big Ben Manila</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadCard()" class="bg-green-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase shadow-md active:scale-95 transition">Save</button>
                            <button id="btnNewCard" onclick="generateCard()" class="bg-white text-london-blue px-3 py-2 rounded-xl text-[10px] font-bold uppercase shadow-lg active:scale-95 transition">New</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="bingoCard" class="border-separate border-spacing-2 mx-auto">
                            <thead class="text-white font-black text-3xl">
                                <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
                            </thead>
                            <tbody class="bg-white rounded-2xl overflow-hidden"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div id="hostControlsPanel" class="hidden bg-london-blue p-6 rounded-3xl shadow-xl text-white">
                    <button id="btnStartGame" onclick="triggerStartGame()" class="w-full bg-royal-red py-3 rounded-xl font-black shadow-lg mb-3 uppercase tracking-tighter">Start Game</button>
                    <div id="activeHostButtons" class="hidden space-y-3">
                        <button onclick="callNumber()" class="w-full bg-green-500 py-4 rounded-xl font-black text-lg shadow-inner uppercase">Call Number</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="toggleJackpotMode()" id="jackpotBtn" class="border border-white/20 py-2 rounded-lg text-[10px] font-bold">BLACKOUT</button>
                            <button onclick="resetBingo()" class="text-white/30 text-[10px] font-bold uppercase">Reset</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-4 border-slate-200">
                    <div class="flex justify-between items-end mb-4 border-b pb-2">
                        <h3 class="font-black text-slate-400 text-xs uppercase tracking-widest">Leaderboard</h3>
                        <div onclick="copyInviteLink()" class="cursor-pointer text-right group">
                            <!-- <span class="text-[8px] font-bold text-slate-400 uppercase block leading-none">Copy Link</span> -->
                            <span id="gameRoomCode" class="text-xs font-black text-london-blue tracking-tighter group-hover:text-royal-red transition">XXXXX</span>
                        </div>
                    </div>
                    <ul id="gamePlayerList" class="space-y-2 max-h-64 overflow-y-auto pr-2"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

  <div id="winnerModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm px-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl border-t-8 border-yellow-400 animate-pop-up relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full bg-yellow-50 opacity-50 pointer-events-none"></div>
        <div class="relative z-10">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-3xl font-black text-london-blue uppercase italic tracking-tighter mb-2">BINGO!</h2>
            <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6">Congratulations</p>
            <div id="winnerNameDisplay" class="text-2xl font-bold text-royal-red mb-8 animate-bounce">
                PLAYER NAME
            </div>
            <button id="modalActionBtn" onclick="closeWinnerModal()" class="bg-london-blue text-white font-bold py-3 px-8 rounded-full shadow-lg active:scale-95 transition uppercase text-sm">
                Keep Playing
            </button>
        </div>
    </div>
  </div>

<footer id="mainFooter" class="fixed bottom-6 flex flex-col items-center gap-2 opacity-60 w-full pointer-events-none">
    <div class="h-px w-24 bg-slate-300"></div>
    <div class="flex items-center gap-2">
      <img src="https://scrmbldgreg.github.io/bingo-manila/assets/gemini-ai-logo.png" alt="Gemini Logo" class="w-4 h-4 md:w-6 md:h-6 animate-pulse">
      <p class="text-[8px] md:text-[10px] font-bold tracking-[0.2em] text-london-blue uppercase">Powered by Gemini AI</p>
    </div>
    <p class="text-[8px] font-medium text-slate-400 tracking-wider uppercase">&copy; 2026 Big Ben Manila</p>
</footer>
<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBznF9jfkpSnKigpMnM706dXL_ZMOjUOAw",
  authDomain: "bingo-manila.firebaseapp.com",
  databaseURL: "https://bingo-manila-default-rtdb.firebaseio.com", 
  projectId: "bingo-manila",
  storageBucket: "bingo-manila.firebasestorage.app",
  messagingSenderId: "792321653174",
  appId: "1:792321653174:web:1cf7c925f055b7134f6917",
  measurementId: "G-4Q004H7XWG"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const LOBBY_LIFETIME = 3 * 60 * 60 * 1000; 
const INACTIVITY_LIMIT = 2 * 60 * 60 * 1000; // 2 Hours Inactivity Limit
let currentLobby = null, myName = null, isHost = false;
let gameNumbersPool = [], calledNumbers = [], isJackpotMode = false, gameStarted = false;
let isRolling = false;
let displayedWinners = new Set(); 

/* ================= NAVIGATION ================= */
function showScreen(id) {
  // Only hide the main page containers
  ['screenInitial', 'screenCreate', 'screenJoin', 'screenLobbyRoom', 'gameArea'].forEach(s => {
    const el = document.getElementById(s);
    if (el) {
      el.classList.add('hidden');
      el.style.display = 'none'; 
    }
  });
  
  const target = document.getElementById(id);
  if (target) {
    target.classList.remove('hidden');
    if (id === 'gameArea') {
      target.style.display = 'flex';
    } else {
      target.style.display = 'block';
    }
  }

  // Handle Footer visibility
  const footer = document.getElementById('mainFooter');
  if (footer) {
    footer.style.display = (id === 'gameArea') ? 'none' : 'flex';
  }

  // DO NOT hide winnerModal here; it is managed by triggerWinnerPopup
}

/* ================= SESSION RECOVERY (NEW LOGIC) ================= */
window.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const roomFromUrl = params.get('room');
  const savedSession = localStorage.getItem('bingo_session');

  if (savedSession) {
    const session = JSON.parse(savedSession);
    const lastActive = session.lastActive || 0;
    
    // Check Inactivity
    if (Date.now() - lastActive > INACTIVITY_LIMIT) {
        console.log("Session expired due to inactivity.");
        localStorage.removeItem('bingo_session');
    } else {
        const snapshot = await db.ref('lobbies/' + session.lobby).get();
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (checkExpiration(data.createdAt)) return;
          currentLobby = session.lobby;
          myName = session.name;
          isHost = (data.host === myName);
          if (isHost) {
            db.ref(`lobbies/${currentLobby}/hostActive`).set(true);
            db.ref(`lobbies/${currentLobby}/hostActive`).onDisconnect().set(false);
          }
          setupLobby();
          if (data.gameState && data.gameState.gameStarted) {
              setTimeout(enterGamePanel, 500);
          }
          return;
        } else {
          localStorage.removeItem('bingo_session');
        }
    }
  } 
  
  if (roomFromUrl) {
    showScreen('screenJoin');
    document.getElementById('joinCode').value = roomFromUrl.toUpperCase();
  }
});

/* ================= CLOUD LOGIC ================= */
function checkExpiration(createdAt) {
  if (createdAt && (Date.now() - createdAt > LOBBY_LIFETIME)) {
    alert("Session expired.");
    localStorage.removeItem('bingo_session');
    if (currentLobby) leaveRoom(true); 
    else location.reload();
    return true;
  }
  return false;
}

async function handleCreateLobby() {
  const name = document.getElementById('hostName').value.trim();
  if (!name) return alert("Enter name");
  const code = Math.random().toString(36).substring(2, 7).toUpperCase();
  currentLobby = code; myName = name; isHost = true;

  await db.ref('lobbies/' + code).set({
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    host: name, 
    players: [name],
    hostActive: true,
    gameState: { calledNumbers: [], isJackpotMode: false, gameStarted: false, winners: [], lastNum: '-' }
  });
  db.ref(`lobbies/${code}/hostActive`).onDisconnect().set(false);
  setupLobby();
}

async function handleJoinLobby() {
  const name = document.getElementById('playerName').value.trim();
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if (!name || !code) return alert("Enter name and code");

  const snapshot = await db.ref('lobbies/' + code).get();
  if (!snapshot.exists()) return alert("Room not found");
  const data = snapshot.val();
  if (checkExpiration(data.createdAt)) return;

  const existingPlayers = data.players || [];
  if (existingPlayers.some(p => p.toLowerCase() === name.toLowerCase())) return alert("Name taken!");

  existingPlayers.push(name);
  await db.ref('lobbies/' + code + '/players').set(existingPlayers);
  currentLobby = code; myName = name; isHost = false;
  setupLobby();
}

function setupLobby() {
  const updateSession = () => {
      localStorage.setItem('bingo_session', JSON.stringify({ 
          lobby: currentLobby, 
          name: myName, 
          isHost: isHost,
          lastActive: Date.now() 
      }));
  };
  updateSession();
  setInterval(updateSession, 5 * 60 * 1000);
  
  document.getElementById('displayCode').textContent = currentLobby;
  showScreen('screenLobbyRoom');
  
  const qrContainer = document.getElementById('qrcode');
  if (qrContainer) {
    qrContainer.innerHTML = '';
    const inviteUrl = `${window.location.origin}${window.location.pathname}?room=${currentLobby}`;
    new QRCode(qrContainer, {
        text: inviteUrl, width: 100, height: 100,
        colorDark : "#002147", colorLight : "#ffffff", 
        correctLevel : QRCode.CorrectLevel.L
    });
  }

  const cancelBtn = document.getElementById('btnCancelLobby');
  if (cancelBtn) cancelBtn.classList.toggle('hidden', !isHost);
  
  db.ref('lobbies/' + currentLobby).on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      alert("Session ended.");
      localStorage.removeItem('bingo_session');
      location.href = window.location.pathname; 
      return;
    }
    if (checkExpiration(data.createdAt)) return;

    const players = data.players || [];
    
    // RENDER LOBBY LIST (Waiting Room)
    const lobbyList = document.getElementById('playerList');
    if (lobbyList) {
        lobbyList.innerHTML = players.map(p => {
          const isHostUser = (p === data.host);
          const isMe = (p === myName);
          const kickBtn = (isHost && !isMe) ? 
            `<button onclick="kickPlayer('${p}')" class="ml-2 text-royal-red font-bold text-[8px] uppercase border border-red-200 px-2 py-1 rounded-md hover:bg-red-50">Kick</button>` : '';
          const leaveBtn = (isMe && !isHost) ? 
            `<button onclick="leaveRoom()" class="ml-2 text-slate-400 font-bold text-[8px] uppercase border border-slate-200 px-2 py-1 rounded-md hover:bg-slate-50">Leave</button>` : '';
          return `<li class="p-2 bg-white rounded-lg border border-slate-100 flex justify-between items-center text-xs shadow-sm animate-fade-in"><span class="font-bold text-slate-700">${p}</span><div class="flex items-center gap-1">${isHostUser ? '<span class="text-[7px] bg-london-blue text-white px-2 py-0.5 rounded-full font-black uppercase">HOST</span>' : ''}${kickBtn} ${leaveBtn}</div></li>`;
        }).join('');
    }

    if (data.gameState) {
        gameStarted = data.gameState.gameStarted;
        calledNumbers = data.gameState.calledNumbers || [];
        isJackpotMode = data.gameState.isJackpotMode;
        
        let currentWinners = data.gameState.winners || [];
        if (typeof currentWinners === 'string') currentWinners = [currentWinners];
        else if (!Array.isArray(currentWinners)) currentWinners = Object.values(currentWinners);

        currentWinners.forEach(w => {
            if (!displayedWinners.has(w)) {
                triggerWinnerPopup(w);
                displayedWinners.add(w);
            }
        });

        // RENDER GAME LIST (With Ranking)
        updatePlayerUI(players, data.host, currentWinners);
        render(data.gameState);
    } else {
        updatePlayerUI(players, data.host, []);
    }
  });
}

function getOrdinal(n) {
  const s = ["th", "st", "nd", "rd"];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function updatePlayerUI(players, hostName, winnerList) {
  const gameList = document.getElementById('gamePlayerList');
  if (!gameList) return;
  gameList.innerHTML = players.map(p => {
    const winnerIndex = winnerList.indexOf(p);
    const isWinner = winnerIndex !== -1;
    const isHostUser = (p === hostName);
    const isMe = (p === myName);
    
    let actionBadge = '';
    if (isHost && !isMe) {
        actionBadge = `<button onclick="kickPlayer('${p}')" class="ml-1 bg-red-100 hover:bg-red-200 text-red-600 font-bold text-[8px] rounded-full px-2 py-0.5 border border-red-200 uppercase transition">Kick</button>`;
    } else if (!isHost && isMe) {
        actionBadge = `<button onclick="leaveRoom()" class="ml-1 bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold text-[8px] rounded-full px-2 py-0.5 border border-slate-200 uppercase transition">Leave</button>`;
    }

    let rankBadge = '';
    if (isWinner) {
        const rank = winnerIndex + 1;
        const ordinal = getOrdinal(rank);
        let colorClass = "bg-slate-100 text-slate-500 border-slate-300"; // Default
        
        if (rank === 1) colorClass = "bg-yellow-100 text-yellow-700 border-yellow-400"; // Gold
        else if (rank === 2) colorClass = "bg-slate-200 text-slate-600 border-slate-400"; // Silver
        else if (rank === 3) colorClass = "bg-orange-100 text-orange-700 border-orange-300"; // Bronze
        
        rankBadge = `<span class="text-[8px] ${colorClass} px-1.5 py-0.5 rounded-full font-black uppercase ml-1 border shadow-sm">${ordinal}</span>`;
    }

    return `<li class="flex items-center justify-between p-2 rounded-lg border ${isWinner ? 'bg-yellow-50 border-yellow-400' : 'bg-slate-50 border-slate-100'}"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${isWinner ? 'bg-yellow-500 animate-pulse' : 'bg-green-500'}"></div><span class="text-xs font-bold ${isWinner ? 'text-yellow-900' : 'text-slate-700'}">${p}</span>${rankBadge}</div><div class="flex items-center">${isHostUser ? '<span class="text-[7px] bg-london-blue text-white px-1.5 py-0.5 rounded-full font-black uppercase">HOST</span>' : ''}${actionBadge}</div></li>`;
  }).join('');
}

function enterGamePanel() {
  showScreen('gameArea');
  const code = currentLobby || "XXXXX";
  
  // Set room code in both the header and the leaderboard card
  // document.getElementById('headerRoomDisplay').textContent = "Room: " + code;
  document.getElementById('gameRoomCode').textContent = code;

  if (isHost) {
    document.getElementById('hostControlsPanel').classList.remove('hidden');
    document.getElementById('btnCloseRoom').classList.remove('hidden'); // Show host close button
  }
  generateCard();
}

function triggerStartGame() {
  if (!confirm("Start game?")) return;
  gameNumbersPool = Array.from({length: 75}, (_, i) => i + 1);
  db.ref('lobbies/' + currentLobby + '/gameState').update({ 
    gameStarted: true, winners: [], calledNumbers: [], lastNum: '-' 
  });
  displayedWinners.clear();
  document.getElementById('btnStartGame').classList.add('hidden');
  document.getElementById('activeHostButtons').classList.remove('hidden');
}

function callNumber() {
  if (gameNumbersPool.length === 0) {
    const flatCalled = calledNumbers.map(n => parseInt(n.split('-')[1]));
    gameNumbersPool = Array.from({length: 75}, (_, i) => i + 1).filter(n => !flatCalled.includes(n));
  }
  if (gameNumbersPool.length === 0) return alert("All numbers called!");
  const idx = Math.floor(Math.random() * gameNumbersPool.length);
  const num = gameNumbersPool.splice(idx, 1)[0];
  const label = (num<=15?'B':num<=30?'I':num<=45?'N':num<=60?'G':'O') + "-" + num;
  calledNumbers.push(label);
  db.ref('lobbies/' + currentLobby + '/gameState').update({ calledNumbers, lastNum: label });
}

function toggleJackpotMode() {
  db.ref('lobbies/' + currentLobby + '/gameState').update({ isJackpotMode: !isJackpotMode });
}

async function leaveRoom(force = false) {
  if (!force && !confirm(isHost ? "End game?" : "Leave game?")) return;
  if (isHost) await db.ref(`lobbies/${currentLobby}`).remove();
  else {
    const snapshot = await db.ref(`lobbies/${currentLobby}/players`).get();
    let players = (snapshot.val() || []).filter(p => p !== myName);
    await db.ref(`lobbies/${currentLobby}/players`).set(players);
  }
  localStorage.removeItem('bingo_session');
  location.href = window.location.pathname;
}

function triggerWinnerPopup(winnerName) {
    const modal = document.getElementById('winnerModal');
    document.getElementById('winnerNameDisplay').textContent = winnerName;
    
    // Ensure hidden is removed and display is flex
    modal.classList.remove('hidden');
    modal.style.display = 'flex'; 
    
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
}

function closeWinnerModal() {
    const modal = document.getElementById('winnerModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none'; // Force hide due to the new layout overrides
    }
}

function render(state) {
  const display = document.getElementById('bingoCurrent');
  const newNum = state.lastNum || '-';
  const nums = state.calledNumbers || [];
  const historyBox = document.getElementById('historyBox');

  const updateGroupedHistory = (numberList) => {
    const groups = { B: [], I: [], N: [], G: [], O: [] };
    numberList.forEach(n => {
      const [letter, num] = n.split('-');
      if (groups[letter]) groups[letter].push(parseInt(num));
    });

    let html = '<div class="grid grid-cols-5 gap-0.5 md:gap-1 w-full h-full">';
    ['B','I','N','G','O'].forEach(letter => {
       html += `
        <div class="flex flex-col gap-1 items-center bg-slate-50 rounded-lg py-1 border border-slate-100 h-full">
           <div class="font-black text-london-blue text-[10px] md:text-sm border-b-2 border-slate-200 w-full text-center pb-1">${letter}</div>
           <div class="flex flex-col gap-0.5 w-full items-center h-full px-1">
             ${groups[letter].sort((a,b)=>a-b).map(n => 
                `<span class="text-[9px] md:text-xs font-bold text-slate-700 bg-white border border-slate-200 w-full text-center rounded shadow-sm">${n}</span>`
             ).join('')}
           </div>
        </div>`;
    });
    html += '</div>';
    historyBox.innerHTML = html;
  };

  if (newNum !== display.dataset.current && newNum !== '-' && !isRolling) {
    isRolling = true;
    display.classList.add('slot-rolling');
    updateGroupedHistory(nums.slice(0,-1));
    let rollCount = 0;
    const rollInterval = setInterval(() => {
      const letters = ['B','I','N','G','O'];
      display.textContent = `${letters[Math.floor(Math.random()*5)]}-${Math.floor(Math.random()*75)+1}`;
      if (++rollCount > 10) {
        clearInterval(rollInterval);
        display.classList.remove('slot-rolling');
        display.textContent = newNum;
        display.dataset.current = newNum;
        isRolling = false;
        updateGroupedHistory(nums);
      }
    }, 80);
  } else if (!isRolling) {
    display.textContent = newNum;
    display.dataset.current = newNum;
    updateGroupedHistory(nums);
  }

  if (!state.gameStarted) clearCardMarksUI();
  
  const btn = document.getElementById('btnNewCard');
  if (state.gameStarted) {
    btn.disabled = true;
    btn.className = "bg-slate-200 text-slate-400 px-2 py-1.5 md:px-3 md:py-2 rounded-lg md:rounded-xl font-bold text-[10px] md:text-xs cursor-not-allowed";
    btn.textContent = "LOCKED";
  } else {
    btn.disabled = false;
    btn.className = "bg-white text-london-blue px-2 py-1.5 md:px-3 md:py-2 rounded-lg md:rounded-xl font-bold text-[10px] md:text-xs shadow-xl active:scale-95 transition";
    btn.textContent = "NEW";
  }
  document.getElementById('jackpotStatus').classList.toggle('hidden', !state.isJackpotMode);
  document.getElementById('jackpotBtn').textContent = state.isJackpotMode ? "CLASSIC" : "BLACKOUT";
}

function clearCardMarksUI() {
  document.querySelectorAll('#bingoCard td').forEach(td => {
    td.classList.remove('marked', 'winning-cell');
    td.classList.add('bg-white');
    if (td.textContent === "FREE") {
      td.classList.remove('bg-white'); td.classList.add('marked');
    }
  });
}

function generateCard() {
  clearCardMarksUI();
  const ranges = [[1,15],[16,30],[31,45],[46,60],[61,75]];
  const cols = ranges.map(r => Array.from({length: 15}, (_,i)=>i+r[0]).sort(()=>Math.random()-0.5).slice(0,5));
  const tbody = document.querySelector('#bingoCard tbody');
  tbody.innerHTML = '';
  document.getElementById('cardOwnerName').textContent = myName || "Your Card";
  document.getElementById('cardWrapper').style.backgroundColor = (Math.random() > 0.5) ? '#002147' : '#b91c1c';

  for (let r=0; r<5; r++) {
    const tr = document.createElement('tr');
    for (let c=0; c<5; c++) {
      const td = document.createElement('td');
      td.className = "w-11 h-11 sm:w-14 sm:h-14 md:w-20 md:h-20 bg-white border-2 border-slate-200 text-sm sm:text-lg md:text-xl font-black cursor-pointer text-center text-london-blue shadow-inner touch-manipulation active:bg-slate-100";
      const val = cols[c][r];
      const label = (val<=15?'B':val<=30?'I':val<=45?'N':val<=60?'G':'O') + "-" + val;
      if (r===2 && c===2) { 
        td.textContent="FREE"; td.classList.add('bg-royal-red', 'marked', 'text-white', 'text-[8px]'); 
      } else { 
        td.textContent = val; td.dataset.label = label; 
        td.onclick = () => { 
            if (r===2 && c===2) return; 
            if (calledNumbers.includes(label)) { 
                td.classList.toggle('marked'); 
                checkWin(); 
            } else { 
                alert("Number not drawn yet!"); 
            } 
        };
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

async function announceWin() {
  // Show locally immediately
  if (!displayedWinners.has(myName)) {
      triggerWinnerPopup(myName);
      displayedWinners.add(myName);
  }
  // Robust Server Update
  const snapshot = await db.ref(`lobbies/${currentLobby}/gameState/winners`).get();
  let winners = snapshot.val() || [];
  if (typeof winners === 'string') winners = [winners];
  else if (!Array.isArray(winners)) winners = Object.values(winners);
  if (!winners.includes(myName)) {
    winners.push(myName);
    await db.ref(`lobbies/${currentLobby}/gameState/winners`).set(winners);
  }
}

function checkWin() {
  const board = Array.from(document.querySelectorAll('#bingoCard tr')).slice(1).map(tr => Array.from(tr.querySelectorAll('td')));
  const isMarked = (td) => td.classList.contains('marked');
  let win = false;
  if (isJackpotMode) { if (board.flat().every(isMarked)) win = true; } 
  else {
    for (let i=0; i<5; i++) {
        if (board[i].every(isMarked)) win = true;
        if (board.map(r => r[i]).every(isMarked)) win = true;
    }
    if ([0,1,2,3,4].every(i => isMarked(board[i][i]))) win = true;
    if ([0,1,2,3,4].every(i => isMarked(board[i][4-i]))) win = true;
  }
  if (win) announceWin();
}

async function downloadCard() {
  const canvas = await html2canvas(document.getElementById('cardWrapper'), { scale: 2 });
  const link = document.createElement('a');
  link.download = `${myName}-Bingo.png`;
  link.href = canvas.toDataURL();
  link.click();
}

function copyInviteLink() {
  const url = `${window.location.origin}${window.location.pathname}?room=${currentLobby}`;
  navigator.clipboard.writeText(url).then(() => {
    document.getElementById('shareBtnText').textContent = "COPIED!";
    setTimeout(() => { document.getElementById('shareBtnText').textContent = "COPY INVITE LINK"; }, 2000);
  });
}

function resetBingo() {
  if (!isHost || !confirm("Reset game?")) return;
  gameNumbersPool = Array.from({length: 75}, (_, i) => i + 1);
  db.ref('lobbies/' + currentLobby + '/gameState').set({ 
    calledNumbers: [], isJackpotMode: false, gameStarted: false, winners: [], lastNum: '-' 
  });
  document.getElementById('btnStartGame').classList.remove('hidden');
  document.getElementById('activeHostButtons').classList.add('hidden');
  displayedWinners.clear();
}
</script>
</body>
</html>
