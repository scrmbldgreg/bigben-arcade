<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spectate | TicTacBlitz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: radial-gradient(circle at top left, #0f172a, #020617); }
    #board {
      display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px);
      width: 300px; height: 300px; border: 4px solid #1e293b; border-radius: 1rem;
      overflow: hidden; background: #0f172a;
    }
    .cell { border: 1px solid #1e293b; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 900; transition: all 0.3s ease; }
    .player-column { transition: all 0.3s ease; width: 220px; border: 2px solid #1e293b; border-radius: 1.5rem; padding: 2rem 1rem; text-align: center; display: flex; flex-direction: column; justify-content: center; gap: 0.5rem; opacity: 0.5; }
    .turn-glow-active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); opacity: 1; }
    .fading { opacity: 0.25; filter: blur(1px); }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen text-white p-4 overflow-hidden relative">

  <div class="absolute top-8 left-8 right-8 flex justify-between items-start">
    <div class="text-left">
      <p class="text-[10px] uppercase tracking-[0.3em] text-slate-500 font-bold mb-1">Live Broadcast</p>
      <h1 class="text-3xl font-black tracking-tighter bg-gradient-to-br from-blue-400 to-pink-500 bg-clip-text text-transparent italic uppercase leading-none">
        TicTacBlitz
      </h1>
      <p class="text-[10px] text-slate-400 mt-2 font-mono uppercase tracking-widest cursor-pointer group" onclick="copySpectateLink()">
          Room: <span class="text-white group-hover:text-blue-400" id="roomNameDisplay">---</span>
          <span class="ml-2 opacity-0 group-hover:opacity-100 text-blue-400 text-[8px] border border-blue-400/30 px-1 rounded transition-all">COPY LINK</span>
      </p>
    </div>

    <button onclick="window.location.href='index.html'" 
            class="bg-red-950/30 border border-red-500/30 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all shadow-lg">
        Exit Spectate
    </button>
  </div>

  <div id="game" class="flex flex-row items-center justify-center gap-12 w-full max-w-6xl">
    <div id="card1" class="player-column">
        <p id="name1" class="text-xs font-bold text-slate-400 uppercase tracking-widest truncate">Searching...</p>
        <p id="role1" class="text-6xl font-black">?</p>
        <p class="text-sm font-black text-slate-300 italic uppercase">Score: <span id="score1" class="text-white">0</span></p>
    </div>

    <div class="flex flex-col items-center">
        <div id="board" class="shadow-2xl shadow-blue-500/10"></div>
        <div class="mt-8 flex flex-col items-center">
            <span id="timerDisplay" class="text-5xl font-black font-mono text-white tracking-tighter">5.0</span>
            <span class="text-[10px] uppercase text-slate-500 font-bold tracking-widest mt-2">Blitz Timer</span>
        </div>
        <div class="mt-6 flex items-center gap-2">
            <div id="statusDot" class="w-2 h-2 rounded-full bg-slate-600"></div>
            <p id="statusLabel" class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Idle</p>
        </div>
    </div>

    <div id="card2" class="player-column">
        <p id="name2" class="text-xs font-bold text-slate-400 uppercase tracking-widest truncate">Searching...</p>
        <p id="role2" class="text-6xl font-black">?</p>
        <p class="text-sm font-black text-slate-300 italic uppercase">Score: <span id="score2" class="text-white">0</span></p>
    </div>
  </div>

  <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 opacity-0 transition-opacity bg-blue-600 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest pointer-events-none">
      Spectate Link Copied!
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const config = { apiKey: "AIzaSyBSaKTzhqAU7EGgB2R614dx6LYUHmak2hE", authDomain: "tictactoe-72e15.firebaseapp.com", projectId: "tictactoe-72e15" };
    const db = getFirestore(initializeApp(config));

    const lid = new URLSearchParams(window.location.search).get('lobby');
    const roomDisp = document.getElementById('roomNameDisplay');
    const statusLabel = document.getElementById('statusLabel');
    const statusDot = document.getElementById('statusDot');

    if(!lid) { window.location.href="index.html"; }
    roomDisp.textContent = lid;

    let lastTime = Date.now();
    let over = false;

    // Build Grid
    const boardEl = document.getElementById('board');
    for(let i=0; i<9; i++) {
        const c = document.createElement('div');
        c.id = `cell-${i}`;
        c.className = 'cell';
        boardEl.appendChild(c);
    }

    onSnapshot(doc(db, "lobbies", lid), (snap) => {
        const d = snap.data();
        if(!d) {
            statusLabel.textContent = "Lobby Closed";
            statusDot.className = "w-2 h-2 rounded-full bg-red-600";
            return;
        }

        statusDot.className = "w-2 h-2 rounded-full bg-red-500 animate-ping";
        statusLabel.textContent = d.started ? "Live Feed" : "In Lobby";

        const p1 = d.players[0], p2 = d.players[1];
        if(p1) {
            document.getElementById('name1').textContent = p1.name;
            document.getElementById('score1').textContent = p1.score;
            document.getElementById('role1').textContent = p1.role || "?";
            document.getElementById('role1').className = `text-6xl font-black ${p1.role === 'X' ? 'text-blue-400' : 'text-pink-500'}`;
        }
        if(p2) {
            document.getElementById('name2').textContent = p2.name;
            document.getElementById('score2').textContent = p2.score;
            document.getElementById('role2').textContent = p2.role || "?";
            document.getElementById('role2').className = `text-6xl font-black ${p2.role === 'X' ? 'text-blue-400' : 'text-pink-500'}`;
        }

        document.getElementById('card1').classList.toggle('turn-glow-active', p1 && d.turn === p1.role);
        document.getElementById('card2').classList.toggle('turn-glow-active', p2 && d.turn === p2.role);

        d.board.forEach((v, i) => { 
            const cell = document.getElementById(`cell-${i}`);
            cell.textContent = v;
            cell.classList.remove('fading');
            cell.className = `cell ${v === 'X' ? 'text-blue-400' : v === 'O' ? 'text-pink-500' : 'text-white'}`;
            if (v && d.piecesOrder[v] && d.piecesOrder[v].length === 3 && d.piecesOrder[v][0] === i) cell.classList.add('fading');
        });

        lastTime = d.lastMoveTime;
        over = !!d.winner;
        if(over) {
            statusLabel.textContent = `${d.winner} WON`;
            statusDot.className = "w-2 h-2 rounded-full bg-green-500";
        }
    });

    setInterval(() => {
        if(over) return;
        const rem = Math.max(0, 5 - (Date.now() - lastTime)/1000).toFixed(1);
        document.getElementById('timerDisplay').textContent = rem;
        document.getElementById('timerDisplay').classList.toggle('text-red-500', rem <= 1.5);
    }, 50);

    window.copySpectateLink = () => {
        navigator.clipboard.writeText(window.location.href).then(() => {
            const t = document.getElementById('toast');
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 2000);
        });
    };
  </script>
</body>
</html>
